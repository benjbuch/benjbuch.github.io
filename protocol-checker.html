---
layout: default
title: Protocol version check
permalink: /check/
---

<div class="checker">
  <h2>Protocol version check</h2>

  <!-- Query form -->
  <p>
  <form id="checker-form" class="checker-form">
    <label for="hash-input">Enter 7+ characters of the commit hash printed on your PDF:</label>
    <div class="row">
      <input id="hash-input" name="q" type="search" maxlength="64" inputmode="latin" autocomplete="off" placeholder="e.g. 5ca0a99" />
      <button type="submit">Check</button>
    </div>
  </form>
</p>

  <!-- Status line -->
  <p id="input-hash"></p>

  <!-- Results -->
  <div id="results"><p class="muted">Waiting for input…</p></div>
</div>

<style>

  .checker {
    margin: 2rem auto;
    max-width: 60ch;
  }
  .checker h1 {
    margin-bottom: 0.75rem;
  }

  /* Form */

  .checker-form {
    margin-bottom: var(--pad-l);
  }
  .checker-form label {
    margin-bottom: var(--pad-m);
    display: block;
  }
  .checker-form .row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--pad-m);
  }
  
  .checker-form button {
    background: var(--surface-raised);
  }
  .checker-form input {
    background: var(--surface-raised);
  }

  /* Results */
  
  .check-result {
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    padding: var(--pad-l);
    margin: var(--pad-l) 0;
    background: var(--surface-raised);
    display: flex !important;
    flex-direction: column !important;
  }
  .check-result > div,
  .check-result > h2,
  .check-result > p {
    display: block !important;
    width: 100% !important;
    margin: 0 0 var(--pad-m) 0 !important;
  }

  /* status section */
  .result-status {
    border-top: 1px solid var(--border);
  }

  /* status badges */
  .status-badge {
    display: inline-block;
    padding: var(--pad-s) var(--pad-m);
    border-radius: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.9rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  .status-current {
    background: var(--accent-green-a);
    color: var(--accent-green);
    border: 1px solid var(--accent-green);
  }
  .status-outdated {
    background: var(--accent-gold-a);
    color: var(--accent-gold);
    border: 1px solid var(--accent-gold);
  }

  /* updates list */
  .updates-list {
    margin: var(--pad-m) 0 0 0;
    padding-left: var(--pad-l);
    list-style-type: disc;
  }
  .updates-list li {
    margin-bottom: var(--pad-m);
  }
  .updates-list li:last-child {
    margin-bottom: 0;
  }

  /* Inline code inside results */
  .check-result code {
    background: var(--surface-inset);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const formEl       = document.getElementById('checker-form');
    const inputField   = document.getElementById('hash-input');
    const inputEl      = document.getElementById('input-hash');
    const resultsEl    = document.getElementById('results');
    
    const params       = new URLSearchParams(window.location.search);
    const initialRaw   = (params.get("q") || "");
    const initialHash  = initialRaw.trim().slice(0, 64);
    
    if (inputField && initialHash) {               
      inputField.value = initialHash;
    }

    if (formEl) {
      formEl.addEventListener("submit", function (evt) {
        evt.preventDefault();
        const newHash = (inputField.value || "").trim();
        const url     = new URL(window.location.href);
        if (newHash) {
          url.searchParams.set("q", newHash);
        } else {
          url.searchParams.delete("q");
        }
        window.history.replaceState(null, "", url.toString());
        runLookup(newHash);
      });
    }

    runLookup(initialHash);

    function parseDateToMs(str) {
      const d = new Date(str);
      if (isNaN(d)) return null;
      return d.getTime();
    }

    function runLookup(queryHash) {
      if (!inputEl || !resultsEl) {
        console.error("Error: Required DOM nodes not found.");
        return;
      }

      if (!queryHash || queryHash.length < 7) {
        inputEl.textContent = "No commit hash provided.";
        resultsEl.innerHTML = "";
        return;
      }

      inputEl.textContent = 'Looking for commit "' + queryHash + '"…';

      var base       = "";
      var indexURL   = base + "/assets/protocols/index.json";
      var historyURL = base + "/assets/protocols/history.json";

      Promise.all([
        fetch(indexURL).then(function (r) {
          if (!r.ok) throw new Error("index.json HTTP " + r.status);
          return r.json();
        }),
        fetch(historyURL).then(function (r) {
          if (!r.ok) throw new Error("history.json HTTP " + r.status);
          return r.json();
        })
      ])
      .then(function (data) {
        var indexData   = data[0];
        var historyData = data[1];

        var qLower = queryHash.toLowerCase();

        var record = indexData.find(function (entry) {
          if (!entry.hash) return false;
          var eLower = String(entry.hash).toLowerCase();
          return eLower.startsWith(qLower);
        });

        if (!record) {
          inputEl.textContent = "";
          resultsEl.innerHTML = 
          '<div class = "check-result">' +
          '<p><strong>Error:</strong> Unrecognized commit <code>' + queryHash + '</code>.</p>' +
          '<p>This PDF may be outdated or not generated from this site.</p>' +
          '</div>';
          return;
        }

        var documentId = record.id;
        var snapshotTimeMs = parseDateToMs(record.time);
        var latestLink = "/assets/protocols/pdf/" + record.filename + ".pdf";

        var changelog = historyData.find(function (item) { return item.id === documentId; });

        var newerChanges = [];
        if (changelog && changelog.changes && snapshotTimeMs !== null) {
          newerChanges = changelog.changes.filter(function (change) {
            var changeMs = parseDateToMs(change.time);
            return changeMs !== null && changeMs > snapshotTimeMs;
          });
          newerChanges.sort(function (a, b) {
            return parseDateToMs(a.time) - parseDateToMs(b.time);
          });
        }

        var snapshotDateStr = "";
        if (snapshotTimeMs !== null) {
          var d = new Date(snapshotTimeMs);
          snapshotDateStr = d.toISOString().slice(0, 10);
        } else {
          snapshotDateStr = record.time;
        }

        var statusHtml = "";
        if (newerChanges.lgth === 0) {
          statusHtml = 
          '<p><strong>Status:</strong> <span class = "status-badge status-current">Current</span></p>' +
          '<p>No recorded changes after ' + snapshotDateStr + '.</p>';
        } else {
          var listItems = newerChanges.map(function (ch) {
            return '<li><strong>' + ch.time + ':</strong> ' + ch.text + '</li>';
          }).join("");

          statusHtml = 
          '<p><strong>Status:</strong> <span class = "status-badge status-outdated">Outdated</span></p>' +
          '<p><a href = "' + latestLink + '" target="_blank" rel="noopener">' +
          'Open the most recent version of ' + documentId +
          '</a></p>' +
          '<p>We have ' + newerChanges.length + ' recorded update' +
          (newerChanges.length > 1 ? 's' : '') + ' after ' + snapshotDateStr + ':</p>' +
          '<ul class = "updates-list">' + listItems + '</ul>';
        }

        inputEl.textContent = "";
        resultsEl.innerHTML = 
        '<section class = "check-result">' +
        '<h2>' + documentId + '</h2>' +
        '<div><strong>Commit:</strong> <code>' + record.hash + '</code></div>' +
        '<div><strong>Snapshot time:</strong> ' + snapshotDateStr + '</div>' +
        '<div class  = "result-status">' + statusHtml + '</div>' +
        '</section>';
      })
      .catch(function (err) {
        console.error("Lookup error:", err);
        inputEl.textContent = "";
        resultsEl.innerHTML = '<div class="check-result"><p><strong>Error:</strong> Could not load protocol index.</p></div>';
      });
    }
  });
</script>