{%- assign page_author = page.author | default: site.owner.name | default: site.author -%}
{%- assign page_last   = page_author | split: ' ' | last | downcase -%}
{%- assign pubs = site.data.publications -%}
{%- comment -%} Collect pinned {%- endcomment -%}
{%- assign pinned = pubs | where: "priority", "pinned" -%}
{%- assign pinned_ids = pinned | map: "id" -%}
{%- comment -%} Sort highs by year desc and exclude pinned {%- endcomment -%}
{%- assign highs_all = pubs | where: "priority", "high" | sort: "year" | reverse -%}
{%- assign highs_filtered = "" | split: "" -%}
{%- for p in highs_all -%}
  {%- unless pinned_ids contains pub.id -%}
    {%- assign highs_filtered = highs_filtered | push: p -%}
  {%- endunless -%}
{%- endfor -%}
{%- assign highs_top5 = highs_filtered | slice: 0, 5 -%}

{%- assign selected = pinned | concat: highs_top5 -%}

{%- if selected and selected.size > 0 -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {%- for pub in selected -%}
    {
      "@type": "ScholarlyArticle",
      "name": {{ pub.title | jsonify }},
      "author": [
        {%- assign authors = pub.authors -%}
        {%- if authors.first -%}
          {%- comment -%}Already an array{%- endcomment -%}
        {%- else -%}
          {%- comment -%}Normalize separators then split{%- endcomment -%}
          {%- assign authors = authors | replace: "; ", " and " | split: " and " -%}
        {%- endif -%}
        {%- if authors and authors.first -%}
          {%- for a in authors -%}
              {%- assign raw = a -%}
              {%- if a contains "," -%}
                {%- assign last = a | split: "," | first | strip -%}
                {%- assign first = a | split: "," | last | strip -%}
              {%- else -%}
                {%- assign last = a | split: ' ' | last  | strip -%}
                {%- assign first = a | remove: last | strip -%}
              {%- endif -%}
              {%- assign pub_last = last | downcase -%}
              {%- if pub_last == page_last -%}
                { "name": {{ page_author | jsonify }} }
              {%- else -%}
                {%- assign full = first | append: ' ' | append: last -%}
                { "name": {{ full | strip | jsonify }} }
              {%- endif -%}
              {%- unless forloop.last %}, {% endunless -%}
            {%- endfor -%}
            {%- else -%}
          { "name": {{ pub.authors | default: site.owner.name | jsonify }} }
        {%- endif -%}
      ],
      {%- if pub.journal -%}
      "isPartOf": { "@type": "Periodical", "name": {{ pub.journal | jsonify }} },
      {%- endif -%}
      {%- if pub.year -%}"datePublished": "{{ pub.year }}",{% endif -%}
      {%- if pub.volume or pub.number or pub.pages -%}
      "pagination": {{ pub.pages | default: pub.page_first | append: "-" | append: pub.page_last | jsonify }},
      {%- endif -%}
      {%- if pub.doi -%}
      "identifier": { "@type": "PropertyValue", "propertyID": "DOI", "value": {{ pub.doi | jsonify }} },
      "url": {{ ("https://doi.org/" | append: pub.doi) | jsonify }}
      {%- else -%}
      "url": {{ pub.url | default: page.url | absolute_url | jsonify }}
      {%- endif -%}
    }{% unless forloopub.last %}, {% endunless %}
    {%- endfor -%}
  ]
}
</script>
{%- endif -%}
