{%- assign page_author = page.author | default: site.owner.name | default: site.author -%}
{%- assign page_last   = page_author | split: ' ' | last | downcase -%}
{%- assign pubs = site.data.publications.publications -%}

{%- assign style = include.style | default: "acs" -%}
{%- assign show_keywords = include.keywords != "false" -%}

{%- assign total_count = pubs | size -%}

<!-- {%- comment -%}Count first authorships{%- endcomment -%}
{%- assign first_auth_count = 0 -%}
{%- for pub in pubs -%}
  {%- assign authors = pub.authors | replace: "; ", " and " | split: " and " -%}
  {%- if authors.size > 0 -%}
    {%- assign first_author = authors[0] | strip | downcase -%}
    {%- if first_author contains page_last -%}
      {%- assign first_auth_count = first_auth_count | plus: 1 -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%} -->

{%- comment -%}Check if any publications have co-first authors{%- endcomment -%}
{%- assign show_cofirst_note = false -%}
{%- for pub in pubs -%}
  {%- if pub.first_authors and pub.first_authors != '' -%}
    {%- assign show_cofirst_note = true -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Define sections: "Display Name::group1::group2::..."{%- endcomment -%}
{%- assign sections = "Preprints::preprint|Original Research::original-research|Reviews, Book Chapters, Monographs::chapter::monograph::review" | split: "|" -%}

<div class="priority-toggle">
  <label class="switch">
    <input type="checkbox" id="priority-toggle" aria-label="Show key publications" checked>
    <span class="switch-ui" aria-hidden="true"></span>
    <span class="switch-text">
      <span class="off">All works</span>
      <span class="on">Selected publications (out of {{ total_count }} works)</span>
    </span>
  </label>
</div>

{%- for sec in sections -%}
  {%- assign parts = sec | split: "::" -%}
  {%- assign section_name = parts[0] -%}
  {%- assign groups = parts | slice: 1, parts.size -%}
  
  {%- comment -%}Collect items matching any of the groups{%- endcomment -%}
  {%- assign items = "" | split: "" -%}
  {%- for pub in pubs -%}
    {%- assign matches = false -%}
    {%- for g in groups -%}
      {%- if pub.group == g or pub.type == g -%}
        {%- assign matches = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if matches -%}
      {%- assign items = items | push: pub -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- if items.size > 0 -%}
  <h3 class="pub-section">{{ section_name }}</h3>
    <ul class="publist" id="pub-list-{{ forloop.index }}">
    {%- for pub in items -%}
      {%- assign nfirst = pub.first_authors | default: 0 | plus: 0 -%}
      
      {%- comment -%}Parse authors{%- endcomment -%}
      {%- assign authors = pub.authors | replace: "; ", " and " | split: " and " -%}
      
      {%- comment -%}Format authors with initials{%- endcomment -%}
      {%- assign formatted_authors = "" -%}
      {%- for a in authors -%}
        {%- assign a = a | strip -%}
        
        {%- comment -%}Parse name: "Last, First" or "First Last"{%- endcomment -%}
        {%- if a contains "," -%}
          {%- assign last = a | split: "," | first | strip -%}
          {%- assign first_block = a | split: "," | last | strip -%}
        {%- else -%}
          {%- assign parts = a | split: " " -%}
          {%- assign last = parts | last -%}
          {%- assign first_parts = "" | split: "" -%}
          {%- for p in parts -%}
            {%- unless forloop.last -%}
              {%- assign first_parts = first_parts | push: p -%}
            {%- endunless -%}
          {%- endfor -%}
          {%- assign first_block = first_parts | join: " " -%}
        {%- endif -%}
        
        {%- comment -%}Generate initials from first names{%- endcomment -%}
        {%- assign first_parts = first_block | split: " " -%}
        {%- assign initials = "" -%}
        {%- for p in first_parts -%}
          {%- if p != "" -%}
            {%- assign chunk = p | replace: ".", "" -%}
            {%- assign hy = chunk | split: "-" -%}
            {%- assign joined = "" -%}
            {%- for h in hy -%}
              {%- assign init = h | strip | slice: 0, 1 | upcase -%}
              {%- assign joined = joined | append: init | append: "." -%}
              {%- unless forloop.last -%}
                {%- assign joined = joined | append: "-" -%}
              {%- endunless -%}
            {%- endfor -%}
            {%- assign initials = initials | append: joined | append: " " -%}
          {%- endif -%}
        {%- endfor -%}
        
        {%- assign abbr_name = initials | append: last -%}
        
        {%- comment -%}Highlight page author{%- endcomment -%}
        {%- assign lname = last | strip | downcase -%}
        {%- if lname == page_last -%}
          {%- assign abbr_name = '<span class="me">' | append: abbr_name | append: '</span>' -%}
        {%- endif -%}
        
        {%- comment -%}Add co-first author marker{%- endcomment -%}
        {%- if forloop.index0 < nfirst -%}
          {%- assign abbr_name = abbr_name | append: "*" -%}
        {%- endif -%}
        
        {%- comment -%}Add separator{%- endcomment -%}
        {%- unless forloop.last -%}
          {%- if style == "acs" -%}
            {%- assign abbr_name = abbr_name | append: "; " -%}
          {%- else -%}
            {%- assign abbr_name = abbr_name | append: ", " -%}
          {%- endif -%}
        {%- endunless -%}
        
        {%- assign formatted_authors = formatted_authors | append: abbr_name -%}
      {%- endfor -%}
      
      {%- comment -%}Parse keywords and create slugs{%- endcomment -%}
      {%- assign kw_list = nil -%}
      {%- if pub.keywords -%}
        {%- if pub.keywords contains "," -%}
          {%- assign kw_list = pub.keywords | split: "," -%}
        {%- elsif pub.keywords contains "|" -%}
          {%- assign kw_list = pub.keywords | split: "|" -%}
        {%- else -%}
          {%- assign kw_list = pub.keywords | split: "," -%}
        {%- endif -%}
      {%- endif -%}
      
      {%- assign tag_slugs = "" -%}
      {%- if kw_list -%}
        {%- for k in kw_list -%}
          {%- assign t = k | strip -%}
          {%- assign slug = t | downcase | replace: " ", "-" | replace: ".", "" | replace: ",", "" | replace: "'", "" -%}
          {%- assign tag_slugs = tag_slugs | append: " tag-" | append: slug -%}
        {%- endfor -%}
      {%- endif -%}
      
      <li class="pub{{ tag_slugs }}" data-priority="{{ pub.priority | default: 'medium' }}" data-num="{{ items.size | minus: forloop.index0 }}">
        <div class="pub-main">
          <div class="pub-line">
            <span class="pub-authors">
              {{ formatted_authors }}
              {%- if style == "acs" %}. {% endif -%}
            </span>
          </div>
            {%- if pub.title -%}
          <div class="pub-line">
            <span class="pub-title">
              {%- if style == "acs" %}{{ pub.title }}. 
              {% else %}"{{ pub.title }}" 
              {% endif -%}
            </span>
          </div>
            {%- endif -%}
          <div class="pub-line">
          {%- if pub.journal or pub.booktitle -%}
            <em>{{ pub.journal | default: pub.booktitle }}</em>
          {%- endif -%}
          {%- if pub.year %} <strong>{{ pub.year }}</strong>{% endif -%}
          {%- if pub.volume %}, <em>{{ pub.volume }}</em>{% endif -%}
          {%- if pub.number %}({{ pub.number }}){% endif -%}
          {%- if pub.pages %}, {{ pub.pages }}{% endif -%}.
          {%- if pub.doi %}
            <span class="pub-id">
              <a href="https://doi.org/{{ pub.doi }}" class="pub-doi">
                <span class="pub-id-full">doi:{{ pub.doi }}</span>
                <span class="pub-id-short">DOI</span>
              </a>
            </span>
          {% endif -%}
          {%- if pub.pmid -%}
            {%- assign pmid_clean = pub.pmid | replace: 'PMID:', '' -%}
            <span class="pub-id">
              <a href="https://pubmed.ncbi.nlm.nih.gov/{{ pmid_clean }}/" class="pub-pmid">
                <span class="pub-id-full">PMID:{{ pmid_clean }}</span>
                <span class="pub-id-short">PMID</span>
              </a>
            </span>
          {%- endif -%}
          {%- if pub.pmcid %}
            <span class="pub-id">
              <a href="https://pmc.ncbi.nlm.nih.gov/articles/{{ pub.pmcid }}/" class="pub-pmcid">
                <span class="pub-id-full">{{ pub.pmcid }}</span>
                <span class="pub-id-short">PMC</span>
              </a>
            </span>
          {% endif -%}
          </div>
        </div>
        
        {%- if show_keywords and kw_list -%}
          <div class="pub-tags">
            {%- for k in kw_list -%}
              {%- assign t = k | strip -%}
              {%- assign slug = t | downcase | replace: " ", "-" | replace: ".", "" | replace: ",", "" | replace: "'", "" -%}
              <button class="tag" type="button" data-tag="{{ slug }}">{{ t }}</button>
            {%- endfor -%}
          </div>
        {%- endif -%}
        
        {%- if (pub.priority == "high" or pub.priority == "pinned") and (pub.impact or pub.myrole) -%}
          <div class="pub-notes">
            {%- if pub.impact %}<span class="note"><strong>Impact:</strong> {{ pub.impact }}</span>{% endif -%}
            {%- if pub.myrole %}<span class="note"><strong>Role:</strong> {{ pub.myrole }}</span>{% endif -%}
          </div>
        {%- endif -%}
      </li>
    {%- endfor -%}
    </ul>
  {%- endif -%}
{%- endfor -%}

<div class="line-split">
  {%- if show_cofirst_note -%}
    <span class="footnote">* <i>denotes equal contribution</i></span>
  {%- endif -%}
  {%- if site.owner.orcid -%}
    <span class="footnote">
      <a href="{{ site.owner.orcid }}">ORCID: {{ site.owner.orcid | split: "/" | last }}</a>
    </span>
  {%- endif -%}
</div>