{%- assign pubs = site.data.publications -%}
{%- assign style = include.style | default: "acs" -%}
{%- assign show_keywords = include.show_keywords | default: true -%}
{%- assign show_sections = include.show_sections | default: true -%}
{%- assign cofirst_any = pubs 
  | where_exp: "i", "i.first_authors"
  | where_exp: "i", "i.first_authors != ''"
-%}
{%- assign show_cofirst_note = cofirst_any.size | default: 0 -%}

{%- assign sections =
  "Preprints::preprint|Original Research::original-research|Reviews, Book Chapters, Monographs::chapter::monograph::review"
  | split: "|" -%}

{%- for sec in sections -%}
  {%- assign parts = sec | split: "::" -%}
  {%- assign section_name = parts[0] -%}

  {%- comment -%}
    parts[1..] gives you all the group identifiers for this section
  {%- endcomment -%}
  {%- assign groups = parts | slice: 1, parts.size -%}

  {%- if groups.size == 1 -%}
    {%- assign items = site.data.publications | where: "group", groups[0] -%}
  {%- else -%}
    {%- assign expr = "" -%}
    {%- for g in groups -%}
      {%- assign expr = expr | append: "i.group == '" | append: g | append: "'" -%}
      {%- unless forloop.last -%}
        {%- assign expr = expr | append: " or " -%}
      {%- endunless -%}
    {%- endfor -%}
    {%- assign items = site.data.publications | where_exp: "i", expr -%}
  {%- endif -%}

  {%- if items and items != empty -%}
    {%- if show_sections -%}<h3 class="pub-section">{{ section_name }}</h3>{%- endif -%}
    {%- assign count = items | size -%}
    {%- if include.ordered -%}
      <ol class="publist" reversed start="{{ count }}">
    {%- else -%}
      <ul class="publist">
    {%- endif -%}
    
      {%- for pub in items -%}
      
        {%- assign nfirst = pub.first_authors | default: 0 | plus: 0 -%}
        
        {%- assign authors = pub.authors -%}
        {%- if authors.first -%}
          {%- comment -%}Already an array{%- endcomment -%}
        {%- else -%}
          {%- comment -%}Normalize separators then split{%- endcomment -%}
          {%- assign authors = authors | replace: "; ", " and " | split: " and " -%}
        {%- endif -%}
        
        {%- assign formatted_authors = "" -%}
        {%- for a in authors -%}
          {%- assign a = a | strip -%}
          {%- comment -%}Detect "Last, First ..." vs "First ... Last"{%- endcomment -%}
          {%- if a contains "," -%}
            {%- assign last = a | split: "," | first | strip -%}
            {%- assign first_block = a | split: "," | last | strip -%}
            {%- assign first_parts = first_block | split: " " -%}
            {%- assign initials = "" -%}
            {%- for p in first_parts -%}
              {%- if p != "" -%}
                {%- assign chunk = p | replace: ".", "" -%}
                {%- assign hy = chunk | split: "-" -%}
                {%- assign joined = "" -%}
                {%- for h in hy -%}
                  {%- assign init = h | strip | slice: 0, 1 | upcase -%}
                  {%- assign joined = joined | append: init | append: "." -%}
                  {%- unless forloop.last -%}{%- assign joined = joined | append: "-" -%}{%- endunless -%}
                {%- endfor -%}
                {%- assign initials = initials | append: joined | append: " " -%}
              {%- endif -%}
            {%- endfor -%}
            {%- assign abbr_name = initials | append: last -%}
          {%- else -%}
            {%- assign parts = a | split: " " -%}
            {%- assign last = parts | last -%}
            {%- assign initials = "" -%}
            {%- for p in parts -%}
              {%- unless forloop.last -%}
                {%- assign chunk = p | replace: ".", "" -%}
                {%- assign hy = chunk | split: "-" -%}
                {%- assign joined = "" -%}
                {%- for h in hy -%}
                  {%- assign init = h | strip | slice: 0, 1 | upcase -%}
                  {%- assign joined = joined | append: init | append: "." -%}
                  {%- unless forloop.last -%}{%- assign joined = joined | append: "-" -%}{%- endunless -%}
                {%- endfor -%}
                {%- assign initials = initials | append: joined | append: " " -%}
              {%- endunless -%}
            {%- endfor -%}
            {%- assign abbr_name = initials | append: last -%}
          {%- endif -%}
          
          {%- capture lname -%}{{ last | strip | downcase }}{%- endcapture -%}
          {%- if lname == 'buchmuller' -%}
            {%- if pub.myrole and pub.myrole != "" -%}
              {%- capture role_tip -%}{{ pub.myrole | escape }}{%- endcapture -%}
              {%- assign abbr_name = '<span class="me" title="' | append: role_tip | append: '">' | append: abbr_name | append: '</span>' -%}
            {%- else -%}
              {%- assign abbr_name = '<span class="me">' | append: abbr_name | append: '</span>' -%}
            {%- endif -%}
          {%- endif -%}
          
          {%- comment -%}Co-first indicator if applicable{%- endcomment -%}
          {%- if forloop.index0 < nfirst -%}
            {%- assign abbr_name = abbr_name | append: "*" -%}
          {%- endif -%}

          {%- comment -%}Separator{%- endcomment -%}
          {%- unless forloop.last -%}
            {%- if style == "acs" -%}
              {%- assign abbr_name = abbr_name | append: "; " -%}
            {%- else -%}
              {%- assign abbr_name = abbr_name | append: ", " -%}
            {%- endif -%}
          {%- endunless -%}

          {%- assign formatted_authors = formatted_authors | append: abbr_name -%}
          
        {%- endfor -%}

        {%- assign kw_list = nil -%}
        {%- if pub.keywords -%}
          {%- if pub.keywords.first -%}
            {%- assign kw_list = pub.keywords -%}
          {%- elsif pub.keywords contains "," -%}
            {%- assign kw_list = pub.keywords | split: "," -%}
          {%- else -%}
            {%- assign kw_list = pub.keywords | split: "|" -%}
          {%- endif -%}
        {%- endif -%}

        {%- assign slug_list = "" | split: "" -%}
        {%- if kw_list -%}
          {%- for k in kw_list -%}
            {%- assign t = k | strip -%}
            {%- assign slug = t | downcase
              | replace: " ", "-"
              | replace: ".", ""
              | replace: ",", ""
              | replace: "’", ""
              | replace: "'", "" -%}
            {%- assign slug_list = slug_list | push: slug -%}
          {%- endfor -%}
          {%- assign slug_list = slug_list | uniq -%}
        {%- endif -%}
        
        {%- assign tag_slugs = "" -%}
        {%- for s in slug_list -%}
          {%- assign tag_slugs = tag_slugs | append: " tag-" | append: s -%}
        {%- endfor -%}
        
        <li class="pub{{ tag_slugs }}">
          <div class="pub-main">
            <span class="pub-authors">{{ formatted_authors }}</span>
            {%- if pub.title -%}{% if style == "acs" %}. {% else %} — {% endif %}<span class="pub-title">“{{ pub.title }}”</span>{%- endif -%}
            {%- if pub.journal %} <em>{{ pub.journal }}</em>{% endif -%}
            {%- if pub.year %} <strong>{{ pub.year }}</strong>{% endif -%}
            {%- if pub.volume %}, {{ pub.volume }}{% endif -%}
            {%- if pub.number %}({{ pub.number }}){% endif -%}
            {%- if pub.pages %}, {{ pub.pages }}{% endif -%}.
            {%- if pub.doi %} <a class="pub-doi" href="https://doi.org/{{ pub.doi }}">doi:{{ pub.doi }}</a>{% endif -%}
            {%- if pub.pmid %} <a class="pub-pmid" href="https://pubmed.ncbi.nlm.nih.gov/{{ pub.pmid }}/">PMID:{{ pub.pmid }}</a>{% endif -%}
            {%- if pub.pmcid %} <a class="pub-pmcid" href="https://pmc.ncbi.nlm.nih.gov/articles/{{ pub.pmcid }}/">{{ pub.pmcid }}</a>{% endif -%}
          </div>

          {%- if show_keywords and kw_list -%}
            <div class="pub-tags">
              {%- for k in kw_list -%}
                {%- assign t = k | strip -%}
                {%- assign slug = t | downcase
                  | replace: " ", "-"
                  | replace: ".", ""
                  | replace: ",", ""
                  | replace: "’", ""
                  | replace: "'", "" -%}
                <button class="tag" type="button" data-tag="{{ slug }}">{{ t }}</button>
              {%- endfor -%}
            </div>
          {%- endif -%}

          {%- if pub.impact or pub.myrole -%}
            <div class="pub-notes">
              {%- if pub.impact %}<span class="note"><strong>Impact:</strong> {{ pub.impact }}</span>{% endif -%}
            </div>
          {%- endif -%}
        </li>
      {%- endfor -%}
    {%- if include.ordered -%}
      </ol>
    {%- else -%}
      </ul>
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

<div class="line-split">
  {%- if show_cofirst_note != 0 -%}
  <span class="pub-footnote">* <i>denotes equal contribution</i></span>
  {%- endif -%}
  <span class="pub-footnote"><a href="https://orcid.org/{{ site.orcid_id }}">ORCID {{ site.orcid_id }}</a></span>
</div>